<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=9" />
		<meta name="generator" content="Doxygen 1.13.2" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>EyeAI: Metric Depth</title>
		<link href="tabs.css" rel="stylesheet" type="text/css" />
		<script type="text/javascript" src="jquery.js"></script>
		<script type="text/javascript" src="dynsections.js"></script>
		<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
 <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
		<link href="doxygen.css" rel="stylesheet" type="text/css" />
		<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="custom.css" rel="stylesheet" type="text/css"/>
		<!-- ... other metadata & script includes ... -->
		<link rel="icon" href="favicon.ico" />
		<!-- extension-dark-mode-toggle -->
		<script
			type="text/javascript"
			src="doxygen-awesome-darkmode-toggle.js"
		></script>
		<script type="text/javascript">
			DoxygenAwesomeDarkModeToggle.init();
		</script>
		<!-- extension-copy-button -->
		<script
			type="text/javascript"
			src="doxygen-awesome-fragment-copy-button.js"
		></script>
		<script type="text/javascript">
			DoxygenAwesomeFragmentCopyButton.init();
		</script>
		<!-- Makes the search result entries font size larger -->
		<script type="text/javascript">
			// This changes the search result font size, as the default is way too small.
			document.addEventListener("DOMContentLoaded", function () {
				const observer = new MutationObserver(function (mutations) {
					const searchIframe = document.querySelector(
						'iframe[name="MSearchResults"]',
					);
					if (searchIframe) {
						searchIframe.addEventListener("load", function () {
							const makeFontLarger = (entries) => {
								for (let i = 0; i < entries.length; i++) {
									entries[i].style.fontSize = "14.4px";
									entries[i].style.paddingTop = "3px";
									entries[i].style.paddingBottom = "3px";
								}
							};
							const searchIframeDoc =
								searchIframe.contentDocument;
							makeFontLarger(
								searchIframeDoc.getElementsByClassName(
									"SREntry",
								),
							);
							makeFontLarger(
								searchIframeDoc.getElementsByClassName(
									"SRScope",
								),
							);
						});
						observer.disconnect();
					}
				});
				observer.observe(document.body, {
					childList: true,
					subtree: true,
				});
			});
		</script>
	</head>
	<body>
		<!-- https://tholman.com/github-corners/ -->
		<a
			href="https://github.com/SimplyExo/eye-ai"
			class="github-corner"
			aria-label="View source on GitHub"
			><svg
				width="80"
				height="80"
				viewBox="0 0 250 250"
				style="
					fill: #151513;
					color: #fff;
					position: absolute;
					top: 0;
					border: 0;
					right: 0;
				"
				aria-hidden="true"
			>
				<path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z" />
				<path
					d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
					fill="currentColor"
					style="transform-origin: 130px 106px"
					class="octo-arm"
				/>
				<path
					d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
					fill="currentColor"
					class="octo-body"
				/></svg></a
		><style>
			.github-corner:hover .octo-arm {
				animation: octocat-wave 560ms ease-in-out;
			}
			@keyframes octocat-wave {
				0%,
				100% {
					transform: rotate(0);
				}
				20%,
				60% {
					transform: rotate(-25deg);
				}
				40%,
				80% {
					transform: rotate(10deg);
				}
			}
			@media (max-width: 500px) {
				.github-corner:hover .octo-arm {
					animation: none;
				}
				.github-corner .octo-arm {
					animation: octocat-wave 560ms ease-in-out;
				}
			}
		</style>
		<div id="top">
			<!-- do not remove this div, it is closed by doxygen! -->
			<div id="titlearea">
				<table cellspacing="0" cellpadding="0">
					<tbody>
						<tr style="height: 56px">
							<td id="projectlogo">
								<img alt="Logo" src="eye-ai-logo-export.webp" />
							</td>
							<td id="projectalign" style="padding-left: 0.5em">
								<div id="projectname">
									EyeAI
								</div>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			<!-- end header part -->
		</div>
	</body>
</html>
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('MetricDepth.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Metric Depth</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Converting relative depth estimation to absolute(/metric) depth using SUNRGB-D (or DIODE) dataset</p>
<p>The Rel2Abs coefficients used in the app are in <code>rel2abs_training/rel2abs_coeffs.npy</code></p>
<p>This is the accuracy of the Rel2Abs coefficients on the validation data of the SUNRGB-D dataset.</p>
<p><code>Average error across dataset: 0.4956 meters</code></p>
<p><code>Median per image average error across dataset: 0.2355 meters</code></p>
<p><img src="rel2abs_training/avg_error_distribution.png" alt="" class="inline"/></p>
<h2>Finding the optimal Rel2Abs coefficients</h2>
<p>Installing python requirements for training the Rel2Abs model:</p>
<p>It is recommended to use python 3.11!</p>
<div class="fragment"><div class="line">cd rel2abs_training</div>
<div class="line">python -m venv venv</div>
<div class="line">source ./venv/bin/activate</div>
<div class="line">pip install --upgrade pip</div>
<div class="line">pip install -r requirements.txt</div>
</div><!-- fragment --><p>Preparing the dataset:</p>
<ol type="1">
<li>Download and extract the dataset:</li>
</ol>
<ul>
<li>SUNRGB-D: <a href="https://rgbd.cs.princeton.edu">https://rgbd.cs.princeton.edu</a> (better fitting images, but less total images)</li>
<li>DIODE: <a href="https://diode-dataset.org">https://diode-dataset.org</a> (more total images, but less fitting)</li>
</ul>
<ol type="1">
<li><p class="startli">Prepare the dataset:</p>
<div class="fragment"><div class="line">cmake --preset=release</div>
<div class="line"> </div>
<div class="line">./scripts/build_and_run_prepare_dataset.sh &lt;diode or sun_rgbd&gt; &lt;dataset_directory&gt; &lt;dataset_evaluation_directory&gt;</div>
</div><!-- fragment --></li>
</ol>
<p>(Optional) 3. Combine multiple datasets into one prepared dataset:</p>
<p>Only if you want to have a larger, more diverse dataset that challenges the model to generalize.</p>
<div class="fragment"><div class="line">python ./scripts/concat_prepared_datasets.py &lt;prepared_dataset_directory_1&gt; &lt;prepared_dataset_directory_2&gt; &lt;output_dataset_directory&gt;</div>
</div><!-- fragment --><p>Running the Rel2Abs model training:</p>
<div class="fragment"><div class="line">cd rel2abs_training</div>
<div class="line">python train.py &lt;prepared_dataset_directory&gt;</div>
</div><!-- fragment --><p>The model will be trained and exported as <code>rel2abs_model.tflite</code></p>
<p>In order to see how the model performs, and what coefficients it uses:</p>
<div class="fragment"><div class="line">cd rel2abs_training</div>
<div class="line">python run.py &lt;raw_relative_depth_samples.npy&gt; &lt;rgbd_image_paths...&gt;</div>
</div><!-- fragment --><p><br  />
</p>
<h2>Rel2Abs coefficients</h2>
<p>In order to find the most optimal coefficients for the Rel2Abs convertion, we train a ai model that predicts these coefficients. After the training of the model, we can see the most optimal coefficients. The Rel2Abs AI-Model is not used within the app, just for discovering the coefficients.</p>
<h2>Rel2Abs model documentation/specification</h2>
<p>input shape: float32[256 * 256 * 4], RGB-D output shape: float32[5], polynomial coeffs for degree 4 polynomial function</p>
<p>the input layer consists of 3 float32 rgb channels in sRGB colorspace in the range [-1, 1]. the fourth channel is a float32 relative depth channel in the range [-1, 1], that is fed the raw relative depth output of MiDaS (in the range of 0 to 1500), but remapped to [-1, 1]. Raw relative depth values larger than 1500 are clamped to 1500, as they are hard to encounter and have no practical relevence, as you need an object &lt;1cm close to the camera to produce such values, which is why clamping is not a problem here.</p>
<p>The output of the model are the coefficients of a polynomial function that is able to convert relative depth values to absolute/metric depth values. For example, a degree 4 polynomial function would require 5 coefficients. However, since neural networks do not train well when the output coeffs can be very small (&lt; 1e-11), as the MSE and MAE appear to be very small, the diffs of the coeffs get ignored while training. To solve this, we scale each coeff individually while training such that the majority of coeffs land in the range of [-1, 1], such that training works as expected. While inference, we scale the output coeffs back down using the inverse of the scaling factor used during training.</p>
<p><br  />
</p>
<h3>How to enable OpenCL (GPU) support on Linux (optional):</h3>
<p>Install opencl dev package: (ubuntu)</p>
<div class="fragment"><div class="line">sudo apt install ocl-icd-opencl-dev</div>
</div><!-- fragment --><p>If you have a NVIDIA card, also install this package:</p>
<div class="fragment"><div class="line">sudo apt install nvidia-opencl-dev</div>
</div><!-- fragment --><p>Verify OpenCL installation:</p>
<div class="fragment"><div class="line">clinfo</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>The NVIDIA OpenCL driver will not load correctly when AddressSanitizer is enabled in cmake (<code>cmake -B build -DEYE_AI_CORE_ENABLE_ASAN=ON</code>). <br  />
<br  />
 An error <code>clGetPlatformIDs returned -1001</code> will occur, and we will fallback into CPU only mode (super slow!). <br  />
<br  />
 To use TFLite GPU delegate using OpenCL with ASAN enabled, you need to set this environment variable when running the program: <br  />
<br  />
 <code>ASAN_OPTIONS=protect_shadow_gap=0 ./build/metric_depth/PrepareDataset ...</code> <br  />
<br  />
 See this stackoverflow post for further information: <a href="https://stackoverflow.com/questions/55750700/opencl-usable-when-compiling-host-application-with-address-sanitizer">https://stackoverflow.com/questions/55750700/opencl-usable-when-compiling-host-application-with-address-sanitizer</a> </dd></dl>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="md_README.html">EyeAICore</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
